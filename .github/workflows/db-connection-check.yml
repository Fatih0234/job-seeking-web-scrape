name: DB Connection Check

on:
  workflow_dispatch: {}

jobs:
  check-db:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg[binary] python-dotenv

      - name: Check DB connectivity (select 1)
        env:
          SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
          SUPABASE_PORT: ${{ secrets.SUPABASE_PORT }}
          SUPABASE_DATABASE: ${{ secrets.SUPABASE_DATABASE }}
          SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
          SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
          SUPABASE_SSLMODE: ${{ secrets.SUPABASE_SSLMODE }}
        run: |
          python - <<'PY'
          from scripts.db import connect

          with connect() as conn:
              with conn.cursor() as cur:
                  cur.execute("select 1")
                  row = cur.fetchone()
                  print(f"DB connection OK. select 1 => {row[0]}")
          PY
